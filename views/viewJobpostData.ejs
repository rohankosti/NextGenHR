<%- include('Layout/header'); %>
    <style>
        table tbody tr {
            transition: transform 0.2s ease;
            border-radius: 100px !important;
        }

        table tbody tr:hover {
            transform: translateX(6px);
            cursor: pointer;
        }

        .action-btn {
            padding: 6px 9px !important;
            /* both equal */
            /* display: flex; */
            align-items: center;
            justify-content: center;
            width: 55px;
            /* same fixed size */
            height: 35px;
        }

        .action-btn i {
            font-size: 14px;
            line-height: 0;
        }
    </style>
    <section>
        <div class="main-content">
            <div class="container py-4 flex-grow-1">
                <div class="topbar rounded-4 mb-4 d-flex justify-content-between align-items-center shadow-sm p-3">
                    <h5>Job Applications</h5>
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> Admin
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">Profile</a></li>
                            <li><a class="dropdown-item" href="#">Settings</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="/Login">Logout</a></li>
                        </ul>
                    </div>
                </div>
                <div>
                    <table id="jobTable" class="table  table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th>Resume</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                    </table>

                </div>
            </div>
        </div>
    </section>



    <div class="modal fade" id="showApplicationModal" tabindex="-1" aria-labelledby="showApplicationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="showApplicationModalLabel">Edit Application Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editApplicationForm">
                    <div class="modal-body">
                        <input type="hidden" id="editId" name="id">
                        <div class="mb-3">
                            <label class="form-label fw-bold" for="editName">Full Name:</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold" for="editEmail">Email address:</label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold" for="editPosition">Position Applied For:</label>
                            <input type="text" class="form-control" id="editPosition" name="position" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold" for="editResume">Resume:</label>
                            <textarea class="form-control" id="editResume" name="resume" rows="4" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="edit">Close</button>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>

        addEventListener("DOMContentLoaded", async () => {
            try {
                $(document).ready(function () {
                    $('#jobTable').DataTable({
                        processing: true,
                        serverSide: true,
                        ajax: {
                            url: '/jobvecancylist',
                            type: 'POST'
                        },
                        columns: [
                            {
                                data: null,
                                render: function (data, type, row, meta) {
                                    return meta.row + meta.settings._iDisplayStart + 1; // serial number
                                }
                            },
                            { data: 'name' },
                            { data: 'email' },
                            { data: 'position' },
                            {
                                data: 'resume',
                                render: function (file) {
                                    return `<a href="/uploads/${file}" target="_blank">View</a>`;
                                }
                            },
                            {
                                data: '_id',
                                render: function (id) {
                                    return `
            <button class="btn btn-primary btn-sm showApplicationBtn" data-id="${id}">Edit</button>
            <button class="btn btn-danger btn-sm delateApplicationBtn" data-id="${id}">Delete</button>
          `;
                                }
                            }
                        ]
                    });
                });


                // Use delegated handlers so buttons added by DataTables receive events
                $('#jobTable').on('click', '.showApplicationBtn', async function (e) {
                    e.preventDefault();
                    const id = $(this).data('id');
                    try {
                        const singlefetch = await fetch('/jobvecancysingledata', {
                            method: 'POST',
                            headers: { 'content-type': 'application/json' },
                            body: JSON.stringify({ id })
                        });
                        const singleresponse = await singlefetch.json();

                        document.getElementById('editId').value = singleresponse._id || '';
                        document.getElementById('editName').value = singleresponse.name || '';
                        document.getElementById('editEmail').value = singleresponse.email || '';
                        document.getElementById('editPosition').value = singleresponse.position || '';
                        document.getElementById('editResume').value = singleresponse.resume || '';

                        const modalEl = document.getElementById('showApplicationModal');
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    } catch (err) {
                        console.error(err);
                        alert('Failed to load application details');
                    }
                });

                // Update Application Details in Modal
                const updateform = document.getElementById('editApplicationForm');
                updateform.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const id = document.getElementById('editId').value;
                    const updateddata = {
                        name: document.getElementById('editName').value,
                        email: document.getElementById('editEmail').value,
                        position: document.getElementById('editPosition').value,
                        resume: document.getElementById('editResume').value,
                    };
                    try {
                        const update_fetch = await fetch(`/updatejobapplicationdata/${id}`, {
                            method: 'PUT',
                            headers: { 'content-type': 'application/json' },
                            body: JSON.stringify({ id, ...updateddata })
                        });
                        const update_response = await update_fetch.json();
                        if (update_fetch.ok) {
                            alert('Application updated successfully!');
                            location.reload();
                        } else {
                            alert(`failed to update application: ${update_response.message}`);
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Update failed');
                    }
                });

                // Delete Application (delegated)
                $('#jobTable').on('click', '.delateApplicationBtn', async function (e) {
                    e.preventDefault();
                    const id = $(this).data('id');
                    if (!confirm('Are you sure you want to delete this application?')) return;
                    try {
                        const delate_fetch = await fetch(`/deletejobapplicationdata/${id}`, {
                            method: 'DELETE',
                            headers: { 'content-type': 'application/json' },
                            body: JSON.stringify({ id })
                        });
                        const delate_response = await delate_fetch.json();
                        if (delate_fetch.ok) {
                            alert(`Application deleted successfully! ${delate_response.message}`);
                            location.reload();
                        } else {
                            alert(`failed to delete application: ${delate_response.message}`);
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Delete failed');
                    }
                });


            }
            catch (error) {
                console.error(error);
            }

        });
    </script>

    <%- include('Layout/footer'); %>