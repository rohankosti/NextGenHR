<%- include('Layout/header'); %>
  <style>
    table tbody tr {
      transition: transform 0.2s ease;
      border-radius: 100px !important;
    }

    table tbody tr:hover {
      transform: translateX(6px);
      cursor: pointer;
    }

    .action-btn {
      padding: 6px 9px !important;
      /* both equal */
      /* display: flex; */
      align-items: center;
      justify-content: center;
      width: 35px;
      /* same fixed size */
      height: 35px;
    }

    .action-btn i {
      font-size: 14px;
      line-height: 0;
    }
  </style>
  <!-- Main Content -->
  <div class="main-content">

    <!-- Topbar -->
    <div class="topbar rounded-4 mb-4 shadow-sm px-3">
      <h5>Attendance Records</h5>
      <div class="dropdown d-flex align-items-center gap-2">

        <!-- Leave Form Button -->
        <a href="/Attendance-form" class="btn btn-primary">
          Attendance Form
        </a>

        <!-- Admin Dropdown -->
        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="bi bi-person-circle"></i> Admin
        </button>

        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#">Profile</a></li>
          <li><a class="dropdown-item" href="#">Settings</a></li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li><a class="dropdown-item" href="/Login">Logout</a></li>
        </ul>

      </div>

    </div>

    <div class="container-fluid">
      <div class="card p-4">

        <!-- <h6 class="mb-3">Attendance List</h6> -->

        <table class="table table-attendance mt-3 align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Employee</th>
              <th>Date</th>
              <th>Check-In</th>
              <th>Check-Out</th>
              <th>Status</th>
              <th colspan="2">Actions</th>
            </tr>
          </thead>

          <tbody id="attendanceTable">
            <!-- JS se dynamically rows aa jayegi -->
          </tbody>

        </table>

      </div>
    </div>

  </div>



  <!-- Update Attendance Modal -->
  <div class="modal fade" id="updateAttendanceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Update Attendance</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <form id="updateAttendanceForm">
            <input type="hidden" id="editId" name="id">
            <!-- Employee -->

            <div class="mb-3">
              <label class="form-label " for="editName">Full Name:</label>
              <input type="text" class="form-control" id="editName" name="name" required>
            </div>

            <!-- Date -->
            <div class="mb-3">
              <label class="form-label">Date</label>
              <input type="date" class="form-control" id="edit_date">
            </div>

            <!-- Check In -->
            <div class="mb-3">
              <label class="form-label">Check In</label>
              <input type="time" class="form-control" id="edit_check_in">
            </div>

            <!-- Check Out -->
            <div class="mb-3">
              <label class="form-label">Check Out</label>
              <input type="time" class="form-control" id="edit_check_out">
            </div>

            <!-- Status -->
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" id="edit_status">
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
                <option value="Leave">Leave</option>
              </select>
            </div>

            <div class="modal-footer d-flex justify-content-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Close
              </button>
              <button type="submit" class="btn btn-primary" id="saveAttendanceBtn">
                Save Changes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>



  <script>
    addEventListener("DOMContentLoaded", async (e) => {
      try {
        
        const attendanceTable = document.getElementById("attendanceTable");

        // Simple date format (DD-MM-YYYY)
        const formatDate = (d) => {
          if (!d) return "";
          const dt = new Date(d);
          return dt.toLocaleDateString("en-GB");
        };

        // Fetch attendance data
        const res = await fetch("http://localhost:3000/getattendancedata");
        const data = await res.json();
        console.log("attendance data:", data);

        // Render table
        data.forEach((e, index) => {
          console.log(e);

          attendanceTable.innerHTML += `
    <tr>
      <td>${index + 1}</td>
       <td>${e.employee_id.first_name + ' ' + e.employee_id.last_name}</td>
      <td>${formatDate(e.date)}</td>
      <td>${e.check_in}</td>
      <td>${e.check_out}</td>
      <td>${e.status}</td>
      <td>
        <button class="btn btn-primary btn-sm action-btn showApplicationBtn" 
                data-bs-toggle="modal" 
                data-bs-target="#updateAttendanceModal"
                data-id="${e._id}">
          <i class="bi bi-pencil"></i>
        </button>

        <button class="btn btn-danger btn-sm action-btn deleteApplicationBtn" 
                data-id="${e._id}">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    </tr>
  `;
        });

        // Show modal with single attendance data
        const showApplicationBtn = document.querySelectorAll(".showApplicationBtn");
        let currentRecord = null;

        showApplicationBtn.forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");

            const sinfetch = await fetch("http://localhost:3000/getsingalattendancedata", {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ id })
            });

            const sindata = await sinfetch.json();
            currentRecord = sindata;

            // Fill modal
            document.getElementById("editId").value = sindata._id;
            document.getElementById("editName").value = empMap[sindata.employee_id] || "Unknown";
            document.getElementById("edit_date").value = sindata.date?.split("T")[0] || "";
            document.getElementById("edit_check_in").value = sindata.check_in || "";
            document.getElementById("edit_check_out").value = sindata.check_out || "";
            document.getElementById("edit_status").value = sindata.status || "";
          });
        });

        // UPDATE Attendance
        const updateAttendanceForm = document.getElementById("updateAttendanceForm");

        updateAttendanceForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const id = document.getElementById("editId").value;

          const upobj = {
            // employee_id: currentRecord.employee_id,
            date: document.getElementById("edit_date").value,
            check_in: document.getElementById("edit_check_in").value,
            check_out: document.getElementById("edit_check_out").value,
            status: document.getElementById("edit_status").value
          };

          const upfetch = await fetch(`http://localhost:3000/updatedattandancedata/${id}`, {
            method: "PUT",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(upobj)
          });

          const updata = await upfetch.json();

          if (upfetch.ok) {
            alert(updata.msg);
            location.reload();
          } else {
            alert("Data Can't Be Updated");
          }
        });


        //  delete api 
        const deltaeApplicationBtn = document.querySelectorAll(".deleteApplicationBtn");
        deltaeApplicationBtn.forEach(btn => {
          btn.addEventListener("click", async (e) => {
            e.preventDefault()
            const delbtn = btn.getAttribute("data-id")
            //  console.log(delbtn);
            const delobj = {
              id: delbtn
            }
            //  console.log(delobj);

            const delfetch = await fetch(`http://localhost:3000/deletedataattandance/${delbtn}`, {
              method: "DELETE",
              headers: {
                "content-type": "application/json"
              },
              body: JSON.stringify(delobj)
            })
            // console.log(delfetch);

            const deldata = await delfetch.json()
            // console.log(deldata);

            if (delfetch.ok) {
              alert(`User Data Delete Sucssesfully`)
              location.reload()
            }

            else {
              alert("User Data Can't be Delete")
            }


          })
        });


      }
      catch (error) {
        console.error("Eroor In Your Side", error);

      }


    })
  </script>

  <%- include('Layout/footer'); %>